<!DOCTYPE html>
<html>
<head>
    <title>Test Bulk Upload Response</title>
</head>
<body>
    <h1>Test Bulk Upload Response</h1>
    <button id="testButton">Test Upload Response</button>
    <div id="result"></div>

    <script>
        document.getElementById('testButton').addEventListener('click', async function() {
            try {
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = '<p>Testing...</p>';
                
                // Simulate the response we expect
                const mockResponse = {
                    "message": "0 students created successfully",
                    "data": {
                        "created": [],
                        "duplicates": 2,
                        "errors": [
                            {
                                "check": "Checking for duplicate student: ST001, john@example.com, 1234567890",
                                "found": "Existing student found: Yes",
                                "duplicate": "Duplicate found: Student with user ID ST001 already exists",
                                "message": "Student with user ID ST001 already exists"
                            },
                            {
                                "check": "Checking for duplicate student: ST002, jane@example.com, 9876543210",
                                "found": "Existing student found: Yes",
                                "duplicate": "Duplicate found: Student with user ID ST002 already exists",
                                "message": "Student with user ID ST002 already exists"
                            }
                        ]
                    },
                    "status": "error"
                };
                
                // Simulate the frontend logic
                const data = mockResponse;
                const entityName = 'student';
                
                resultDiv.innerHTML = '<h2>Mock Response:</h2><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                // More robust error detection
                const hasErrors = data && data.status === 'error';
                const hasDataErrors = data && data.data && data.data.errors && data.data.errors.length > 0;
                const hasTopLevelErrors = data && data.errors && data.errors.length > 0;
                
                resultDiv.innerHTML += '<h2>Error Detection:</h2>';
                resultDiv.innerHTML += '<p>Has errors: ' + hasErrors + '</p>';
                resultDiv.innerHTML += '<p>Has data errors: ' + hasDataErrors + '</p>';
                resultDiv.innerHTML += '<p>Has top level errors: ' + hasTopLevelErrors + '</p>';
                
                if (hasErrors || hasDataErrors || hasTopLevelErrors) {
                    // Format error messages for better display
                    const errorSource = data.errors || (data.data && data.data.errors) || [];
                    
                    let errorMessages = '';
                    if (entityName === 'student' && hasDataErrors) {
                        // For students, show the detailed duplicate information
                        errorMessages = data.data.errors.map(error => {
                            if (typeof error === 'object' && error !== null) {
                                // If it's the new detailed error object with check, found, and duplicate properties
                                if (error.check && error.found && error.duplicate) {
                                    return `${error.check}\n${error.found}\n${error.duplicate}`;
                                } else if (error.message) {
                                    return error.message;
                                } else {
                                    return JSON.stringify(error);
                                }
                            } else if (typeof error === 'string' && error.includes('Student with')) {
                                // Extract the duplicate information from the backend message
                                return error;
                            } else if (typeof error === 'string') {
                                return error;
                            } else {
                                return JSON.stringify(error);
                            }
                        }).join('\n\n');
                    }
                    
                    resultDiv.innerHTML += '<h2>Formatted Error Messages:</h2><pre>' + errorMessages + '</pre>';
                    resultDiv.innerHTML += '<h2>Expected Display:</h2><div style="border: 1px solid #ccc; padding: 10px; white-space: pre;">' + errorMessages + '</div>';
                } else {
                    resultDiv.innerHTML += '<p>No errors detected</p>';
                }
            } catch (error) {
                document.getElementById('result').innerHTML = '<p>Error: ' + error.message + '</p>';
            }
        });
    </script>
</body>
</html>